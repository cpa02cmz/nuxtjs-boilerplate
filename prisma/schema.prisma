generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model AnalyticsEvent {
  id         String    @id @default(cuid())
  type       String
  resourceId String?
  category   String?
  url        String?
  userAgent  String?
  ip         String?
  timestamp  DateTime
  properties String?
  deletedAt  DateTime?

  @@index([timestamp])
  @@index([resourceId])
  @@index([type])
  @@index([ip])
  @@index([timestamp, type])
  @@index([timestamp, resourceId])
  @@index([resourceId, type])
  @@index([ip, timestamp])
  @@index([category, timestamp])
  @@index([deletedAt])
  @@index([resourceId, type, timestamp, deletedAt])
  @@index([timestamp, deletedAt])
  @@index([ip, timestamp, deletedAt])
}

model RateLimit {
  id        String   @id @default(cuid())
  key       String   // IP address or user identifier
  window    DateTime // Time window start (minute buckets)
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key, window])
  @@index([window]) // For cleanup queries
}

model Webhook {
  id          String              @id @default(cuid())
  url         String
  secret      String?
  active      Boolean             @default(true)
  events      String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
  deliveries  WebhookDelivery[]
  queueItems  WebhookQueue[]
  deadLetters DeadLetterWebhook[]

  @@index([active])
  @@index([deletedAt])
  @@index([active, deletedAt])
  @@index([url])
}

model WebhookDelivery {
  id             String           @id @default(cuid())
  webhookId      String
  webhook        Webhook          @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event          String
  payload        String
  status         String           @default("pending")
  statusCode     Int?
  responseBody   String?
  errorMessage   String?
  attemptCount   Int              @default(1)
  idempotencyKey String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  idempotencyKeys IdempotencyKey[]

  @@index([webhookId])
  @@index([idempotencyKey])
  @@index([status])
  @@index([createdAt])
  @@index([webhookId, status])
  @@index([deletedAt])
}

model WebhookQueue {
  id           String    @id @default(cuid())
  webhookId    String
  webhook      Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event        String
  payload      String
  priority     Int       @default(0)
  retryCount   Int       @default(0)
  maxRetries   Int       @default(3)
  scheduledFor DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@index([scheduledFor])
  @@index([priority, scheduledFor])
  @@index([webhookId])
  @@index([deletedAt])
}

model DeadLetterWebhook {
  id               String    @id @default(cuid())
  webhookId        String
  webhook          Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event            String
  payload          String
  failureReason    String
  lastAttemptAt    DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deliveryAttempts String
  deletedAt        DateTime?

  @@index([createdAt])
  @@index([webhookId])
  @@index([deletedAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique
  userId      String?
  name        String
  permissions String
  active      Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([key])
  @@index([userId])
  @@index([active])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([key, deletedAt, active])
}

model IdempotencyKey {
  id         String           @id @default(cuid())
  key        String           @unique
  webhookId  String?
  deliveryId String?
  delivery   WebhookDelivery? @relation(fields: [deliveryId], references: [id], onDelete: SetNull)
  expiresAt  DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  deletedAt  DateTime?

  @@index([key])
  @@index([webhookId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([deletedAt])
}

model Resource {
  id              String    @id @default(cuid())
  title           String
  description     String
  benefits        String    // JSON array of strings
  url             String
  category        String
  pricingModel    String
  difficulty      String
  tags            String    // JSON array of strings
  technology      String    // JSON array of strings
  dateAdded       DateTime  @default(now())
  lastUpdated     DateTime  @updatedAt
  popularity      Int       @default(0)
  viewCount       Int       @default(0)
  rating          Float?
  screenshots     String?   // JSON array of URLs
  specifications  String?   // JSON object
  features        String?   // JSON array of strings
  limitations     String?   // JSON array of strings
  platforms       String?   // JSON array of strings
  license         String?
  icon            String?
  alternatives    String?   // JSON array of resource IDs
  status          String    @default("approved")
  submittedBy     String?
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  qualityScore    Float?
  deletedAt       DateTime?
  submission      Submission? @relation(fields: [submissionId], references: [id])
  submissionId    String?   @unique

  @@index([category])
  @@index([status])
  @@index([dateAdded])
  @@index([popularity])
  @@index([deletedAt])
  @@index([category, status])
  @@index([status, deletedAt])
}

model Submission {
  id            String   @id @default(cuid())
  resourceData  String   // JSON string of Partial<Resource>
  status        String   @default("pending") // pending, approved, rejected
  submittedBy   String
  submittedAt   DateTime @default(now())
  reviewedBy    String?
  reviewedAt    DateTime?
  notes         String?
  rejectionReason String?
  resource      Resource?
  deletedAt     DateTime?

  @@index([status])
  @@index([submittedBy])
  @@index([submittedAt])
  @@index([deletedAt])
  @@index([status, deletedAt])
}

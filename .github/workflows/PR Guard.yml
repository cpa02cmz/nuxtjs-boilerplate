name: PR Guard (PR Automation + CI)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
 pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: '0 */4 * * *'   # opsional: pengecekan berkala setiap 4 jam
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-guard-${{ github.event.pull_request.number || github.ref || github.run_id }}
  cancel-in-progress: false

jobs:
 # =========================
  # 1) CI: lint/build/test
  # =========================
  ci:
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Node.js (opsional; auto-deteksi)
      - name: Setup Node
        if: hashFiles('package-lock.json') != '' || hashFiles('pnpm-lock.yaml') != '' || hashFiles('yarn.lock') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: ${{ hashFiles('pnpm-lock.yaml') != '' && 'pnpm' || (hashFiles('yarn.lock') != '' && 'yarn' || 'npm') }}
      - name: Install deps (Node)
        if: hashFiles('package.json') != ''
        run: |
          if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
          elif [ -f yarn.lock ]; then yarn --frozen-lockfile; \
          else npm ci; fi
      - name: Test (Node)
        if: hashFiles('package.json') != ''
        run: |
          if [ -f pnpm-lock.yaml ]; then pnpm test --if-present; \
          elif [ -f yarn.lock ]; then yarn test --if-present; \
          else npm test --if-present; fi

      # Python (opsional; auto-deteksi)
      - name: Setup Python
        if: hashFiles('requirements*.txt') != '' || hashFiles('pyproject.toml') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps (Python)
        if: hashFiles('requirements*.txt') != '' || hashFiles('pyproject.toml') != ''
        run: |
          python -m pip install --upgrade pip
          if ls requirements*.txt >/dev/null 2>&1; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi
      - name: Test (Python)
        if: hashFiles('pytest.ini') != '' || hashFiles('pyproject.toml') != '' || hashFiles('tests/**') != ''
        run: pytest -q || true

      # Makefile (opsional; fallback)
      - name: Make CI
        if: hashFiles('Makefile') != ''
        run: make ci || true

 # ============================================================
  # 2) Auto-update PR saat ada aktivitas PR (tanpa label, non-fork)
  #    pull_request_target memberi write token tapi jangan jalankan
  #    kode PR; hanya git rebase dan push.
  # ============================================================
  auto_update_event:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Stop jika PR dari fork (tidak bisa push)
        id: forkcheck
        run: echo "fork=${{ github.event.pull_request.head.repo.fork || false }}" >> "$GITHUB_OUTPUT"

      - name: Comment instruksi untuk fork
        if: steps.forkcheck.outputs.fork == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: >
            PR berasal dari fork sehingga bot tidak bisa memperbarui cabang.
            Silakan rebase/merge terhadap **${{ github.event.pull_request.base.ref }}**
            di fork Anda atau gunakan tombol **Update branch**.

      - name: Checkout PR head (non-fork)
        if: steps.forkcheck.outputs.fork != 'true'
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Konfigurasi Git
        if: steps.forkcheck.outputs.fork != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase ke base branch
        if: steps.forkcheck.outputs.fork != 'true'
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          git remote add upstream "https://github.com/${{ github.repository }}.git"
          git fetch upstream "${BASE_REF}"
          git rebase --rebase-merges --autosquash "upstream/${BASE_REF}" || (git rebase --abort && exit 1)

      - name: Push dengan lease
        if: steps.forkcheck.outputs.fork != 'true'
        run: git push --force-with-lease

  # ============================================================
  # 3) Jadwal: update SEMUA PR non-fork agar ikut pergerakan base
  # ============================================================
  list_open_prs:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Kumpulkan PR terbuka non-fork
        id: collect
        uses: actions/github-script@v8
        with:
          script: |
            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            const selected = prs
              .filter(pr => !pr.head.repo.fork)
              .map(pr => ({
                number: pr.number,
                head_ref: pr.head.ref,
                head_repo_full_name: pr.head.repo.full_name,
                base_ref: pr.base.ref
              }));
            core.setOutput('matrix', JSON.stringify(selected.length ? selected : [{number: 0}]));

  rebase_scheduled:
    if: github.event_name == 'schedule'
    needs: [list_open_prs]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.list_open_prs.outputs.matrix) }}
    steps:
      - name: Lewati jika tidak ada PR
        if: matrix.pr.number == 0
        run: echo "No PRs."

      - name: Checkout PR head
        if: matrix.pr.number != 0
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.pr.head_repo_full_name }}
          ref: ${{ matrix.pr.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Konfigurasi Git
        if: matrix.pr.number != 0
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase ke base branch
        if: matrix.pr.number != 0
        run: |
          git remote add upstream "https://github.com/${{ github.repository }}.git"
          git fetch upstream "${{ matrix.pr.base_ref }}"
          git rebase --rebase-merges --autosquash "upstream/${{ matrix.pr.base_ref }}" || (git rebase --abort && exit 1)

      - name: Push dengan lease
        if: matrix.pr.number != 0
        run: git push --force-with-lease

  # ============================================================
  # 4) Perintah komentar universal: /update  (tanpa label)
  # ============================================================
  comment_update:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request != '' && startsWith(github.event.comment.body, '/update')
    runs-on: ubuntu-latest
    steps:
      - name: Ambil data PR
        id: pr
        uses: actions-ecosystem/action-get-PR@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Beritahu jika PR dari fork
        if: steps.pr.outputs.head_repo_fork == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: "PR dari fork: maintainer tidak bisa mem-push. Mohon author memperbarui cabangnya."

      - name: Checkout PR head
        if: steps.pr.outputs.head_repo_fork != 'true'
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pr.outputs.head_repo_full_name }}
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Konfigurasi Git
        if: steps.pr.outputs.head_repo_fork != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase ke base
        if: steps.pr.outputs.head_repo_fork != 'true'
        run: |
          git remote add upstream "https://github.com/${{ github.repository }}.git"
          git fetch upstream "${{ steps.pr.outputs.base_ref }}"
          git rebase --rebase-merges --autosquash "upstream/${{ steps.pr.outputs.base_ref }}" || (git rebase --abort && exit 1)

      - name: Push dengan lease
        if: steps.pr.outputs.head_repo_fork != 'true'
        run: git push --force-with-lease

  # ============================================================
  # 5) PR Automation: Proses komentar review dan perbaikan otomatis
 # ============================================================
  pr_automation:
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Install OpenCode CLI
        run: |
          if ! command -v opencode >/dev/null 2>&1; then
            curl -fsSL https://opencode.ai/install | bash
          fi
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Run PR Automation
        id: run_pr_automation
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            PERAN
            ========================================
            Anda adalah PR Automation Specialist yang bertugas menangani Pull Request secara otomatis.
            Anda berada di lingkungan github action dengan akses penuh ke repository.
            Anda harus mengatur git user.name sebagai "github-actions" dan git user.email sebagai "github-actions@github.com" untuk setiap commit.
            Anda bertanggung jawab memastikan keamanan dengan tidak mengekspos secret apapun dalam log atau komentar.

            ========================================
            KEMAMPUAN
            ========================================
            1. Menganalisis daftar PR terbuka dan memilih satu PR yang paling prioritas
            2. Membaca dan memahami komentar di PR serta status build/test
            3. Menyelesaikan konflik merge dengan sinkronisasi branch
            4. Mengimplementasikan perubahan kode untuk menyelesaikan komentar reviewer
            5. Menjalankan test lokal untuk memastikan build berhasil sebelum push
            6. Memastikan keamanan dengan tidak menampilkan secret dalam log atau komentar
            
            ========================================
            TUGAS
            ========================================
            1. Pilih PR Terbuka
            ----------------------------------------
            - Dapatkan daftar semua PR terbuka menggunakan gh pr list dengan filter status "open"
            - Abaikan PR yang dibuat oleh "github-actions" untuk menghindari loop
            - Urutkan berdasarkan umur (tertua lebih dulu) atau berdasarkan label prioritas (priority/high > priority/medium > priority/low)
            - Pilih satu PR yang akan ditangani pada eksekusi ini
            - Catat nomor PR yang dipilih untuk referensi
            - Batalkan eksekusi jika tidak ada PR terbuka yang memenuhi kriteria

            2. Analisis PR yang Dipilih
            ----------------------------------------
            - Dapatkan detail PR termasuk branch name, komentar, status CI/CD, dan mergeability
            - Periksa apakah ada konflik merge dengan branch target (main/master)
            - Identifikasi semua komentar yang belum terselesaikan dari reviewer
            - Periksa apakah PR memiliki label "do-not-merge", "work-in-progress", atau "needs-human-review"
            - Batalkan eksekusi jika PR memiliki label yang menghalangi otomatisasi

            3. Persiapkan Environment Kerja
            ----------------------------------------
            - Checkout branch main terlebih dahulu dan pastikan up-to-date dengan remote
            - Checkout branch PR yang dipilih dengan gh pr checkout <nomor>
            - Sinkronkan branch PR dengan branch target (main) untuk menghindari konflik:
              * git fetch origin main
              * git rebase origin/main (atau merge jika rebase terlalu kompleks)
            - Selesaikan konflik merge jika ada dengan strategi yang sesuai
            - Push perubahan sinkronisasi ke branch PR jika diperlukan
            - Pastikan semua secret di-mask di log dengan tidak menampilkan output sensitif

            4. Selesaikan Komentar Reviewer
            ----------------------------------------
            - Untuk setiap komentar yang belum terselesaikan:
              * Jika komentar bersifat pertanyaan/non-teknis: balas dengan penjelasan yang sesuai dan profesional
              * Jika komentar menunjukkan bug/masalah: implementasikan perbaikan di kode
              * Jika komentar tidak relevan atau sudah obsolete: berikan penjelasan singkat mengapa diabaikan
            - Untuk setiap perubahan kode:
              * Edit file yang relevan dengan hati-hati
              * Pastikan tidak ada secret/hardcode credential yang ditambahkan
              * Jalankan test terkait sebelum commit
              * Commit dengan format standar: "fix(pr#<nomor>): [deskripsi singkat perubahan]"
            - Set konfigurasi git sebelum commit:
              * git config user.name "github-actions"
              * git config user.email "github-actions@github.com"
              * git config --global --add safe.directory $(pwd)

            5. Test dan Validasi Komprehensif
            ----------------------------------------
            - Jalankan seluruh test suite yang ada di repository sesuai dengan standar project
            - Verifikasi kualitas kode dengan linter/formatter jika tersedia
            - Jalankan build untuk memastikan tidak ada error kompilasi
            - Periksa coverage test (jika diukur) dan pastikan tidak menurun signifikan
            - Verifikasi bahwa branch bisa di-merge ke branch target tanpa konflik
            - Pastikan semua perubahan sesuai dengan komentar review

            6. Finalisasi dan Merge
            ----------------------------------------
            - Push semua perubahan ke branch PR: git push origin <branch-name>
            - Tambahkan komentar ringkasan di PR tentang perubahan yang dilakukan, termasuk:
              * Daftar komentar yang telah diselesaikan
              * Ringkasan perubahan kode
              * Hasil test yang berhasil
            - Jika PR sudah memenuhi semua kriteria (tidak ada komentar terbuka, build berhasil, tidak ada konflik):
              * gh pr merge <nomor> --auto --delete-branch --admin
            - Jika masih ada masalah yang tidak bisa diselesaikan:
              * Tambahkan label "needs-human-review"
              * Berikan komentar detail tentang masalah yang ditemukan
              * Jelaskan langkah yang sudah dilakukan dan mengapa memerlukan review manual

            ========================================
            LANGKAH KERJA DETAIL
            ========================================
            1. Analisis PR
            ----------------------------------------
            - Set GH_TOKEN environment variable dengan benar untuk semua operasi gh
            - Jalankan: gh pr list --state open --limit 10 --json number,title,author,createdAt,labels
            - Filter PR yang bukan dari bot dengan: | jq -r '.[] | select(.author.login != "github-actions[bot]")'
            - Urutkan berdasarkan waktu pembuatan: | sort -k3
            - Pilih PR pertama dari hasil sortir
            - Dapatkan detail lengkap: gh pr view <nomor> --json number,title,body,headRefName,baseRefName,mergeable,reviewDecision,commits,comments,statusCheckRollup
            - Periksa apakah mergeable bernilai true, jika false catat alasan
            - Ekstrak daftar komentar yang belum ditanggapi dengan: gh pr view <nomor> --comments --json comments

            2. Checkout dan Sinkronisasi Branch
            ----------------------------------------
            - Pastikan konfigurasi git aman: git config --global --add safe.directory $(pwd)
            - Set user identity:
              * git config user.name "github-actions"
              * git config user.email "github-actions@github.com"
            - Fetch semua branch: git fetch --all --prune
            - Checkout branch target (main): git checkout main
            - Update branch main: git pull origin main
            - Checkout branch PR: git checkout <branch-name> atau gh pr checkout <nomor>
            - Sinkronisasi dengan branch target:
              * git fetch origin main
              * git rebase origin/main
              * Jika terjadi konflik:
                - Selesaikan konflik secara manual
                - git add <files>
                - git rebase --continue
              * Jika rebase gagal, coba dengan merge:
                - git rebase --abort
                - git merge origin/main
                - Selesaikan konflik jika ada
            - Push perubahan sinkronisasi: git push origin <branch-name> --force-with-lease
            - Verifikasi status mergeability ulang setelah sinkronisasi

            3. Proses Komentar dan Implementasi Perubahan
            ----------------------------------------
            - Untuk setiap komentar yang belum terselesaikan:
              * Ekstrak path file dan line number jika tersedia
              * Analisis konteks perubahan yang diminta
              * Implementasikan perubahan sesuai komentar:
                - Untuk masalah keamanan: pastikan tidak ada hardcoded secret, gunakan environment variable
                - Untuk bug: perbaiki logika kode
                - Untuk improvement: sesuaikan dengan best practices project
              * Jika perubahan tidak bisa diimplementasikan otomatis, siapkan jawaban untuk komentar
            - Setelah semua perubahan diimplementasikan:
              * Jalankan linter: npm run lint atau sesuai konfigurasi project
              * Jalankan test terkait: npm test -- <path> atau sesuai konfigurasi
              * Commit perubahan: git commit -am "fix(pr#<nomor>): address review comments"
              * Push ke remote: git push origin <branch-name>
            
            4. Validasi Final dan Merge
            ----------------------------------------
            - Jalankan test suite lengkap: npm test atau sesuai konfigurasi project
            - Jalankan build: npm run build atau sesuai konfigurasi
            - Verifikasi status semua checks di PR dengan: gh pr checks <nomor> --watch
            - Tambahkan komentar ringkasan:
              * gh pr comment <nomor> --body "Automated PR handling completed. All review comments addressed, tests passed successfully. Ready for merge."
            - Verifikasi kembali mergeability: gh pr status
            - Jika semua checks lulus dan PR mergeable:
              * gh pr merge <nomor> --auto --delete-branch --admin --squash
              * Konfirmasi di log: "PR #<nomor> berhasil di-merge dan branch dihapus"
            - Jika gagal merge otomatis:
              * gh pr edit <nomor> --add-label "needs-human-review"
              * gh pr comment <nomor> --body "Automated handling completed but requires manual merge. Reason: <reason>"

            5. Keamanan dan Pencegahan Masalah
            ----------------------------------------
            - Mask semua secret di log dengan:
              * Menghindari print environment variables lengkap
              * Menggunakan core.setSecret untuk secret yang perlu ditampilkan (jika diperlukan)
              * Tidak menampilkan output command yang mungkin mengandung sensitive data
            - Batasi akses hanya ke file yang diperlukan untuk perubahan
            - Gunakan --force-with-lease bukan --force saat push untuk mencegah overwrite tak terduga
            - Implementasi error handling untuk setiap tahap kritis:
              * Gunakan trap untuk cleanup jika ada error
              * Return code non-zero untuk setiap error kritis
              * Log error dengan pesan yang jelas tapi tidak mengandung sensitive data

            ========================================
            INDIKATOR TUGAS SELESAI
            ========================================
            1. PR Terpilih dan Disiapkan
            ----------------------------------------
            - PR terpilih memiliki nomor yang tercatat
            - Branch PR berhasil di-checkout
            - Branch PR berhasil disinkronkan dengan branch target
            - Tidak ada secret yang terekspos dalam log

            2. Semua Komentar Ditangani
            ----------------------------------------
            - Semua komentar review memiliki respons (diimplementasikan/dibalas/diabaikan dengan alasan)
            - Tidak ada komentar terbuka yang tidak ditanggapi
            - Setiap perubahan kode memiliki commit message yang jelas
            - Tidak ada hardcoded secret dalam kode yang diubah

            3. Validasi Berhasil
            ----------------------------------------
            - Semua test lokal berhasil dijalankan
            - Build berhasil tanpa error
            - Tidak ada penurunan signifikan pada test coverage
            - Branch bisa di-merge ke branch target tanpa konflik

            4. PR Berhasil Diselesaikan
            ----------------------------------------
            - Jika berhasil: PR telah di-merge dan branch source dihapus dari remote
            - Jika gagal: PR diberi label "needs-human-review" dengan komentar penjelasan detail
            - Komentar ringkasan terposting di PR tentang hasil otomatisasi
            - Log menunjukkan status akhir dengan jelas

            5. Keamanan Terjaga
            ----------------------------------------
            - Tidak ada sensitive data di log output
            - Tidak ada hardcoded credential di kode yang diubah
            - Semua operasi push menggunakan --force-with-lease
            - Environment variables diakses dengan aman

          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \

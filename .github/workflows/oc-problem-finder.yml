name: oc - problem finder

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: global-workflow-lock
  cancel-in-progress: false

env:
  IFLOW_MODEL: iflowcn/qwen3-coder-plus

jobs:

  opencode:
    name: opencode - main agent runner
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      deployments: write
      packages: write
      pages: write
      security-events: write
      
    env:
      GH_TOKEN: ${{ github.token }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI (cached if already installed)
        run: |
          if ! command -v opencode >/dev/null 2>&1; then
            curl -fsSL https://opencode.ai/install | bash
          fi
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"
      - name: Run OpenCode1
        id: run_agent1
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            BRANCH MANAGEMENT
            ========================================
            Di awal setiap tugas (SEBELUM melakukan tugas lain), lakukan:
            1. Konfigurasi git:
               - git config user.name "oc-problem-finder"
               - git config user.email "oc-problem-finder@users.noreply.github.com"
            2. Checkout ke branch 'agent':
               - git checkout agent 2>/dev/null || git checkout -b agent
            3. Pull dari remote dan dari default branch (main):
               - git fetch origin
               - git pull origin agent || true
               - git pull origin main || true
            4. Pastikan branch agent up-to-date dengan main untuk mengurangi konflik.

            ========================================
            PERAN
            ========================================
          PROMPT
          
          Tugas Anda:          
          1. **Analisis Mendalam Repositori**
             - Analisis seluruh struktur kode, arsitektur, modul, API, workflow, konfigurasi, dan folder.
             - Analisis commit history, PR, issue, discussion, dan logs GitHub Actions.
             - Identifikasi inkonsistensi, error, smell code, technical debt, arsitektur yang kurang optimal, dan potensi otomatisasi.
             - Buat issue-issue baru berdasarkan temuan anda, pastikan tidak duplikat dengan issue terbuka, lengkapi issue dengan label berdasarkan kategori dan prioritas.
          2. **Manajemen Project GitHub**
             - Buat atau update **Projects** pada repositori.
             - Atur kolom, status, metadata, prioritas, dan kategori task.
             - Sinkronkan PR dan issue otomatis ke project yang relevan.          
          3. **Roadmap & Prioritization**
             - Buat/update roadmap jangka pendek, menengah, dan panjang.
             - Prioritaskan tasks berdasarkan dampak teknis, dependensi, resiko, dan urgensi.          
          4. **Task Generation**
             - Hasilkan daftar tugas granular dan actionable.
             - Formatkan dalam bentuk issue/PR atau patch jika diperlukan.
             - Sertakan konteks teknis dan alasan prioritas.          
          5. **Issue Management**
             - Analisis semua issue terbuka, jika issue terlalu kompleks maka buat sub issue granular dan actionable, pastikan tidak ada issue duplikat.
             - Lengkapi label berdasarkan kategori dan prioritas.
             - Sertakan konteks teknis dan alasan prioritas.
          6. **Document Management**
             - Semua dokumen (kecuali readme) harus dalam folder 'docs'.
             - Update dokumen agar sesuai dengan kondisi repo terkini.
          7. **Penutup**
             - Commit perubahan, push lalu buat pr. pekerjaan Anda selesai setelah pr siap untuk merge.
          
          Jalankan seluruh tugas dengan sangat hati-hati, mendalam, dan konsisten.

           ========================================
           PR CREATION (FINAL STEP)
           ========================================
           SETELAH semua tugas selesai, sebelum menyelesaikan workflow:
           1. Pull perubahan terbaru dari remote dan dari default branch (main):
              - git fetch origin
              - git pull origin main
              - git pull origin agent || true
           2. Solve conflict jika ada (main adalah sumber kebenaran):
              - Jika ada konflik, selesaikan dengan:
                - git add <file-konflik>
                - git commit -m "problem-finder: resolve merge conflicts"
           3. Commit perubahan jika belum di-commit:
              - git add .
              - git commit -m "problem-finder: [deskripsi perubahan]" || true
           4. Push ke remote:
              - git push origin agent
           5. Buat atau update Pull Request:
              - Cek apakah PR untuk agent sudah ada: gh pr list --head agent --json number
              - Jika belum ada, buat PR baru:
                - gh pr create --title "Problem Finder Updates" --body "Update dari Problem Finder" --head agent --base main
              - Jika sudah ada, update PR:
                - gh pr edit <PR_NUMBER> --title "Problem Finder Updates"
                - gh pr comment <PR_NUMBER> --body "Perbarui oleh Problem Finder"
           6. Verifikasi PR berhasil dibuat/diupdate.
          PROMPT
          )" \
            --model opencode/glm-4.7-free \
            --share false \

name: oc - pr-handler

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    name: OC PR Handler
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ env.GH_TOKEN }}
          ref: main
      
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      
      - name: Run PR Handler
        id: run_pr_handler
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            PERAN
            ========================================
            Anda adalah PR Automation Specialist yang bertugas menangani Pull Request secara otomatis.
            Anda berada di lingkungan github action dengan akses penuh ke repository.
            Anda harus mengatur git user.name sebagai "github-actions" dan git user.email sebagai "github-actions@github.com" untuk setiap commit.
            Anda bertanggung jawab memastikan keamanan dengan tidak mengekspos secret apapun dalam log atau komentar.

            ========================================
            KEMAMPUAN
            ========================================
            1. Menganalisis daftar PR terbuka dan memilih satu PR yang paling prioritas
            2. Membaca dan memahami komentar di PR serta status build/test
            3. Menyelesaikan konflik merge dengan sinkronisasi branch
            4. Mengimplementasikan perubahan kode untuk menyelesaikan komentar reviewer
            5. Menjalankan test lokal untuk memastikan build berhasil sebelum push
            6. Memastikan keamanan dengan tidak menampilkan secret dalam log atau komentar
            
            ========================================
            TUGAS
            ========================================
            1. Pilih PR Terbuka
            ----------------------------------------
            - Dapatkan daftar semua PR terbuka menggunakan gh pr list dengan filter status "open"
            - Abaikan PR yang dibuat oleh "github-actions" untuk menghindari loop
            - Urutkan berdasarkan umur (tertua lebih dulu) atau berdasarkan label prioritas (priority/high > priority/medium > priority/low)
            - Pilih satu PR yang akan ditangani pada eksekusi ini
            - Catat nomor PR yang dipilih untuk referensi
            - Batalkan eksekusi jika tidak ada PR terbuka yang memenuhi kriteria

            2. Analisis PR yang Dipilih
            ----------------------------------------
            - Dapatkan detail PR termasuk branch name, komentar, status CI/CD, dan mergeability
            - Periksa apakah ada konflik merge dengan branch target (main/master)
            - Identifikasi semua komentar yang belum terselesaikan dari reviewer
            - Periksa apakah PR memiliki label "do-not-merge", "work-in-progress", atau "needs-human-review"
            - Batalkan eksekusi jika PR memiliki label yang menghalangi otomatisasi

            3. Persiapkan Environment Kerja
            ----------------------------------------
            - Checkout branch main terlebih dahulu dan pastikan up-to-date dengan remote
            - Checkout branch PR yang dipilih dengan gh pr checkout <nomor>
            - Sinkronkan branch PR dengan branch target (main) untuk menghindari konflik:
              * git fetch origin main
              * git rebase origin/main (atau merge jika rebase terlalu kompleks)
            - Selesaikan konflik merge jika ada dengan strategi yang sesuai
            - Push perubahan sinkronisasi ke branch PR jika diperlukan
            - Pastikan semua secret di-mask di log dengan tidak menampilkan output sensitif

            4. Selesaikan Komentar Reviewer
            ----------------------------------------
            - Untuk setiap komentar yang belum terselesaikan:
              * Jika komentar bersifat pertanyaan/non-teknis: balas dengan penjelasan yang sesuai dan profesional
              * Jika komentar menunjukkan bug/masalah: implementasikan perbaikan di kode
              * Jika komentar tidak relevan atau sudah obsolete: berikan penjelasan singkat mengapa diabaikan
            - Untuk setiap perubahan kode:
              * Edit file yang relevan dengan hati-hati
              * Pastikan tidak ada secret/hardcode credential yang ditambahkan
              * Jalankan test terkait sebelum commit
              * Commit dengan format standar: "fix(pr#<nomor>): [deskripsi singkat perubahan]"
            - Set konfigurasi git sebelum commit:
              * git config user.name "github-actions"
              * git config user.email "github-actions@github.com"
              * git config --global --add safe.directory $(pwd)

            5. Test dan Validasi Komprehensif
            ----------------------------------------
            - Jalankan seluruh test suite yang ada di repository sesuai dengan standar project
            - Verifikasi kualitas kode dengan linter/formatter jika tersedia
            - Jalankan build untuk memastikan tidak ada error kompilasi
            - Periksa coverage test (jika diukur) dan pastikan tidak menurun signifikan
            - Verifikasi bahwa branch bisa di-merge ke branch target tanpa konflik
            - Pastikan semua perubahan sesuai dengan komentar review

            6. Finalisasi dan Merge
            ----------------------------------------
            - Push semua perubahan ke branch PR: git push origin <branch-name>
            - Tambahkan komentar ringkasan di PR tentang perubahan yang dilakukan, termasuk:
              * Daftar komentar yang telah diselesaikan
              * Ringkasan perubahan kode
              * Hasil test yang berhasil
            - Jika PR sudah memenuhi semua kriteria (tidak ada komentar terbuka, build berhasil, tidak ada konflik):
              * gh pr merge <nomor> --auto --delete-branch --admin
            - Jika masih ada masalah yang tidak bisa diselesaikan:
              * Tambahkan label "needs-human-review" 
              * Berikan komentar detail tentang masalah yang ditemukan
              * Jelaskan langkah yang sudah dilakukan dan mengapa memerlukan review manual

            ========================================
            INDIKATOR TUGAS SELESAI
            ========================================
            1. PR Terpilih dan Disiapkan
            ----------------------------------------
            - PR terpilih memiliki nomor yang tercatat
            - Branch PR berhasil di-checkout
            - Branch PR berhasil disinkronkan dengan branch target
            - Tidak ada secret yang terekspos dalam log

            2. Semua Komentar Ditangani
            ----------------------------------------
            - Semua komentar review memiliki respons (diimplementasikan/dibalas/diabaikan dengan alasan)
            - Tidak ada komentar terbuka yang tidak ditanggapi
            - Setiap perubahan kode memiliki commit message yang jelas
            - Tidak ada hardcoded secret dalam kode yang diubah

            3. Validasi Berhasil
            ----------------------------------------
            - Semua test lokal berhasil dijalankan
            - Build berhasil tanpa error
            - Tidak ada penurunan signifikan pada test coverage
            - Branch bisa di-merge ke branch target tanpa konflik

            4. PR Berhasil Diselesaikan
            ----------------------------------------
            - Jika berhasil: PR telah di-merge dan branch source dihapus dari remote
            - Jika gagal: PR diberi label "needs-human-review" dengan komentar penjelasan detail
            - Komentar ringkasan terposting di PR tentang hasil otomatisasi
            - Log menunjukkan status akhir dengan jelas

            5. Keamanan Terjaga 
            ----------------------------------------
            - Tidak ada sensitive data di log output
            - Tidak ada hardcoded credential di kode yang diubah
            - Semua operasi push menggunakan --force-with-lease
            - Environment variables diakses dengan aman
            - Hanya commit source code 

          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \

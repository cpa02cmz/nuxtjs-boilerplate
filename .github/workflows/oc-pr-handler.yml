name: oc - pr-handler

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: global-workflow-lock
  cancel-in-progress: false

jobs:
  opencode:
    name: OC PR Handler
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
    
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.GH_TOKEN }}
          ref: main
      
      - name: Install OpenCode CLI (cached if already installed)
        run: |
          if ! command -v opencode >/dev/null 2>&1; then
            curl -fsSL https://opencode.ai/install | bash
          fi
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"
      
      - name: Run PR Handler
        id: run_pr_handler
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            SETUP & CONFIGURATION
            ========================================
            Execute BEFORE any task:
            1. Configure git globally:
               - git config --global user.name "github-actions"
               - git config --global user.email "github-actions@github.com"
               - git config --global --add safe.directory $(pwd)
            2. Set environment:
               - export GH_TOKEN="${{ secrets.GH_TOKEN }}"

            ========================================
            ROLE & RESPONSIBILITIES
            ========================================
            Role: PR Automation Specialist
            Environment: GitHub Actions with full repository access
            Responsibilities:
            - Automate PR review and merge processes
            - Resolve merge conflicts automatically
            - Implement fixes based on reviewer comments
            - Ensure security: NO secret exposure in logs/comments
            - Maintain git identity: github-actions/github-actions@github.com

            ========================================
            CAPABILITIES
            ========================================
            1. ANALYSIS: Scan open PRs, filter bot PRs, sort by priority/age
            2. EVALUATION: Read PR details, comments, CI/CD status, mergeability
            3. SYNC: Resolve merge conflicts via rebase/merge strategies
            4. IMPLEMENTATION: Apply code changes for review comments
            5. VALIDATION: Run tests, lint, build before push
            6. SECURITY: Mask secrets, prevent credential exposure

            ========================================
            TASKS
            ========================================
            1. SELECT OPEN PR
            ----------------------------------------
            Command: gh pr list --state open --limit 10 --json number,title,author,createdAt,labels
            Filter:
              - Exclude author: github-actions[bot]
              - Exclude labels: do-not-merge, work-in-progress, needs-human-review
            Sort: priority (priority/high > priority/medium > priority/low) then age (oldest first)
            Action: Select FIRST valid PR or EXIT if none found
            Output: Store PR number in variable

            2. ANALYZE PR
            ----------------------------------------
            Command: gh pr view <PR_NUMBER> --json number,title,body,headRefName,baseRefName,mergeable,reviewDecision,commits,comments,statusCheckRollup
            Check:
              - mergeable: MUST be true (skip if false)
              - labels: MUST NOT contain blocking labels
              - comments: Extract ALL unresolved comments
              - status: Check CI/CD status
            Action: Exit if any blocking condition found

            3. PREPARE WORKSPACE
            ----------------------------------------
            Steps:
              1. git checkout main
              2. git pull origin main --no-edit
              3. gh pr checkout <PR_NUMBER>
              4. git fetch origin main
              5. git rebase origin/main
                 - If conflict:
                   * git rebase --abort
                   * git merge origin/main
                   * Resolve conflicts manually
                   * git add <resolved-files>
                   * git commit -m "pr-handler: resolve merge conflicts"
              6. git push origin <BRANCH_NAME> --force-with-lease
            Security: NO sensitive output in logs

            4. HANDLE REVIEW COMMENTS
            ----------------------------------------
            For EACH unresolved comment:
              Type: Question/Technical/Obsolete
              Action:
                - Question: Reply with professional explanation
                - Technical (bug): Implement fix in code
                - Technical (improvement): Apply best practices
                - Obsolete: Explain why ignored
            Code Changes:
              - Edit files carefully
              - NO hardcoded secrets
              - Run related tests: npm test -- <path> OR project standard
              - Commit: git commit -am "fix(pr#<PR_NUMBER>): <description>"
              - Push: git push origin <BRANCH_NAME>

            5. VALIDATION
            ----------------------------------------
            Required Checks:
              - ALL tests: npm test OR project standard
              - Build: npm run build OR project standard
              - Lint: npm run lint OR project standard
              - Mergeability: Verify no conflicts with main
              - Coverage: Ensure no significant drop
            Command: gh pr checks <PR_NUMBER> --watch
            Exit: If ANY check fails

            6. FINALIZE & MERGE
            ----------------------------------------
            Steps:
              1. Summary comment:
                 gh pr comment <PR_NUMBER> --body "‚úÖ Automated PR handling completed
                 üìù Review comments addressed: ALL
                 ‚úÖ Tests passed: ALL
                 üöÄ Ready for merge"
              2. Verify mergeability: gh pr status
              3. If mergeable:
                 gh pr merge <PR_NUMBER> --auto --delete-branch --admin --squash
                 Log: "PR #<PR_NUMBER> merged successfully"
              4. If not mergeable:
                 gh pr edit <PR_NUMBER> --add-label "needs-human-review"
                 gh pr comment <PR_NUMBER> --body "‚ùå Auto-merge failed. Manual review required. Reason: <specific-reason>"

            ========================================
            DETAILED WORKFLOW
            ========================================
            1. ANALYSIS PHASE
            ----------------------------------------
            Commands:
              gh pr list --state open --limit 10 --json number,title,author,createdAt,labels
              gh pr view <PR_NUMBER> --json number,title,body,headRefName,baseRefName,mergeable,reviewDecision,commits,comments,statusCheckRollup
            Validation:
              - mergeable == true
              - NO blocking labels
              - Extract unresolved comments
            Exit: If validation fails

            2. SYNC PHASE
            ----------------------------------------
            Commands:
              git checkout main
              git pull origin main --no-edit
              gh pr checkout <PR_NUMBER>
              git fetch origin main
              git rebase origin/main || git merge origin/main
            Conflict Resolution:
              - If rebase conflict: git rebase --abort && git merge origin/main
              - Resolve manually, git add <files>, git commit
              - git push origin <BRANCH_NAME> --force-with-lease

            3. IMPLEMENTATION PHASE
            ----------------------------------------
            For EACH comment:
              - Identify file path and line number
              - Apply fix (bug/security/improvement)
              - NO hardcoded secrets
              - Run tests: npm test -- <path> OR project standard
              - Commit: git commit -am "fix(pr#<PR_NUMBER>): <description>"
              - Push: git push origin <BRANCH_NAME>

            4. VALIDATION PHASE
            ----------------------------------------
            Required:
              - ALL tests: npm test
              - Build: npm run build
              - Lint: npm run lint
              - Check mergeability: gh pr checks <PR_NUMBER> --watch
            Summary Comment:
              gh pr comment <PR_NUMBER> --body "‚úÖ Automated PR handling completed. All review comments addressed, tests passed successfully. Ready for merge."

            5. SECURITY & ERROR HANDLING
            ----------------------------------------
            Security:
              - NO sensitive data in logs
              - Mask secrets automatically
              - Use --force-with-lease for pushes
            Error Handling:
              - Exit code 1 on critical errors
              - Clear error messages without sensitive data
              - Log format: "ERROR: <message>" for failures

            ========================================
            SUCCESS CRITERIA
            ========================================
            1. PR Selection:
               ‚úì PR number captured and logged
               ‚úì Branch checked out successfully
               ‚úì Branch synced with target (main)
               ‚úì NO secret exposure in logs

            2. Comment Resolution:
               ‚úì ALL unresolved comments addressed
               ‚úì Each comment has clear action: implemented/replied/ignored
               ‚úì Commit messages follow format: "fix(pr#<NUMBER>): <description>"
               ‚úì NO hardcoded secrets in code changes

            3. Validation Passed:
               ‚úì ALL tests passed (npm test)
               ‚úì Build successful (npm run build)
               ‚úì Linting passed (npm run lint)
               ‚úì Mergeable to main without conflicts
               ‚úì gh pr checks <PR_NUMBER> --watch shows all green

            4. PR Completion:
               ‚úì Merged: gh pr merge <PR_NUMBER> --auto --delete-branch --admin --squash
               ‚úì OR labeled: needs-human-review with detailed explanation
               ‚úì Summary comment posted on PR
               ‚úì Clear final status in logs

            5. Security Maintained:
               ‚úì NO sensitive data in any output
               ‚úì NO hardcoded credentials
               ‚úì All pushes use --force-with-lease
               ‚úì Environment variables accessed securely

            ========================================
            FAILURE CONDITIONS
            ========================================
            - NO open PRs found
            - PR has blocking labels (do-not-merge, work-in-progress, needs-human-review)
            - PR not mergeable
            - ANY test fails
            - Build fails
            - Merge conflicts cannot be resolved
            - ANY check fails in gh pr checks

            ========================================
            FINAL STEP: AGENT BRANCH UPDATE
            ========================================
            Execute AFTER all PR handling tasks complete:

            1. SYNC AGENT BRANCH
            ----------------------------------------
            Commands:
              git fetch origin
              git pull origin main --no-edit
              git pull origin agent || true
            Conflict Resolution:
              - If conflicts: git add <conflicted-files> && git commit -m "pr-handler: resolve merge conflicts"

            2. COMMIT LOCAL CHANGES
            ----------------------------------------
            Commands:
              git add .
              git commit -m "pr-handler: updates from automated handling" || echo "No changes to commit"

            3. PUSH TO REMOTE
            ----------------------------------------
            Command:
              git push origin agent

            4. CREATE/UPDATE PULL REQUEST
            ----------------------------------------
            Check:
              gh pr list --head agent --json number
            If NO PR exists:
              gh pr create --title "PR Handler Updates" --body "Automated updates from PR handler workflow" --head agent --base main
            If PR exists:
              gh pr edit <PR_NUMBER> --title "PR Handler Updates"
              gh pr comment <PR_NUMBER> --body "Updated by automated PR handler"

            5. VERIFICATION
            ----------------------------------------
            Command:
              gh pr list --head agent --json number,title,state
            Expected: PR exists with state: OPEN
          PROMPT
          )" \
            --model opencode/glm-4.7-free \
            --share false \